steps:
  - label: "🔍 Lint & Test"
    command: |
      pip install -r flask/requirements.txt
      flake8 flask/
      pytest flask/
    key: test

  - label: "🐳 Build & Push Docker Image to Docker Hub"
    command: |
      IMAGE_TAG=${BUILDKITE_COMMIT:0:7}
      docker build -t manueltattolo/flask-app:$IMAGE_TAG .
      echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      docker push manueltattolo/flask-app:$IMAGE_TAG
    key: build
    depends_on: test

  - label: "🚀 Deploy to Minikube"
    command: |
      IMAGE_TAG=${BUILDKITE_COMMIT:0:7}
      kubectl config use-context minikube
      kubectl set image deployment/flask-app flask-app=manueltattolo/flask-app:$IMAGE_TAG
    key: deploy
    depends_on: build
